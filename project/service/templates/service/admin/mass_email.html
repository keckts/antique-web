{% extends 'dashboard/base.html' %} {% block content %} {% load static %}

<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}" />

<style>
  .container {
    max-width: 900px;
    margin: 40px auto;
    padding: 25px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
  }
  h1 {
    margin-bottom: 25px;
    font-size: 2rem;
    color: #333;
  }
  .form-group {
    margin-bottom: 20px;
  }
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #555;
  }
  input[type="text"],
  input[type="file"],
  select,
  button {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  button {
    background-color: #007bff;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:hover {
    background-color: #0056b3;
  }
  #quill-editor {
    height: 300px;
  }
  .draft-section {
    display: flex;
    gap: 15px;
    align-items: flex-end;
    margin-bottom: 20px;
  }
  .draft-section select {
    flex: 1;
  }
</style>

<div class="container">
  <h1>Mass Email Dashboard</h1>

  {% if messages %}
  <ul>
    {% for message in messages %}
    <li class="{{ message.tags }}">{{ message }}</li>
    {% endfor %}
  </ul>
  {% endif %}

  <!-- Draft selector -->
  <div class="draft-section">
    <div class="form-group">
      <label for="drafts">Select Draft</label>
      <select id="drafts">
        <option value="">-- New Template --</option>
        {% for draft in drafts %}
        <option
          value="{{ draft.id }}"
          data-subject="{{ draft.subject }}"
          data-body="{{ draft.body|escapejs }}"
        >
          {{ draft.name }}
        </option>
        {% endfor %}
      </select>
    </div>
    <button type="button" id="load-draft" class="btn">Load Draft</button>
  </div>

  <form
    method="POST"
    action="{% url 'service:send_mass_email_view' %}"
    enctype="multipart/form-data"
  >
    {% csrf_token %}

    <div class="form-group">
      <label for="subject">Subject</label>
      <input
        type="text"
        id="subject"
        name="subject"
        placeholder="Email subject"
        required
      />
    </div>

    <div class="form-group">
      <label for="message">Message</label>
      <div id="quill-editor"></div>
      <input type="hidden" name="message" id="message-input" />
    </div>

    <div class="form-group">
      <label for="image">Attach Image (optional)</label>
      <input type="file" id="image" name="image" accept="image/*" />
    </div>

    <div class="form-group" style="display: flex; gap: 15px">
      <button type="submit">Send Email</button>
      <button
        type="button"
        id="save-draft"
        class="btn"
        style="background-color: #28a745"
      >
        Save Draft
      </button>
    </div>
  </form>
</div>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
  const quill = new Quill("#quill-editor", {
    theme: "snow",
    placeholder: "Compose your email here...",
    modules: {
      toolbar: [
        [{ header: [1, 2, 3, false] }],
        ["bold", "italic", "underline", "strike"],
        ["blockquote", "code-block"],
        [{ list: "ordered" }, { list: "bullet" }],
        ["link", "image"],
        ["clean"],
      ],
    },
  });

  // On form submit, transfer Quill content
  const form = document.querySelector("form");
  form.onsubmit = function () {
    document.getElementById("message-input").value = quill.root.innerHTML;
  };

  // Load draft
  document.getElementById("load-draft").onclick = function () {
    const draftSelect = document.getElementById("drafts");
    const selected = draftSelect.options[draftSelect.selectedIndex];
    if (selected.value) {
      document.getElementById("subject").value = selected.dataset.subject;
      quill.root.innerHTML = selected.dataset.body;
    } else {
      document.getElementById("subject").value = "";
      quill.root.innerHTML = "";
    }
  };

  // Save draft (AJAX)
  document.getElementById("save-draft").onclick = function () {
    const subject = document.getElementById("subject").value;
    const body = quill.root.innerHTML;
    if (!subject || !body.trim()) {
      alert("Subject and message cannot be empty!");
      return;
    }
    fetch("{% url 'service:save_email_draft' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ subject, body }),
    })
      .then((res) => res.json())
      .then((data) => {
        alert("Draft saved successfully!");
        location.reload(); // reload to show in dropdown
      })
      .catch((err) => console.error(err));
  };
</script>
{% endblock %}
