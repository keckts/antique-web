{% extends 'dashboard/base.html' %}
{% load static %}

{% block content %}
<head>
  <link rel="stylesheet" href="{% static 'css/antiques/view_antiques.css' %}" />

</head>

<div class="antiques-container">
  <div class="header-section">
    <h2 class="page-title">Browse Antiques</h2>
    <p class="subtitle">Discover timeless treasures from our curated collection</p>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-filter-section">
    <!-- Search Input -->
    <div class="search-wrapper">
      <i class="fa-solid fa-search search-icon"></i>
      <input
        type="text"
        id="searchInput"
        class="search-input"
        placeholder="Search antiques by title or description..."
        value="{{ request.GET.search|default:'' }}"
      />
    </div>

    <!-- Type Filter -->
    <div class="filter-wrapper">
      <select id="typeFilter" class="filter-select">
        <option value="">All Types</option>
        {% for type in antique_types %}
        <option value="{{ type }}" {% if request.GET.type == type %}selected{% endif %}>
          {{ type }}
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Sold Toggle -->
    <div class="filter-wrapper">
      <label class="toggle-switch">
        <input
          type="checkbox"
          id="showSoldToggle"
          {% if show_sold %}checked{% endif %}
        />
        <span class="slider"></span>
      </label>
      <span class="toggle-label">Show Sold Antiques</span>
    </div>

    <!-- Results Count -->
    <div class="results-info">
      <span id="resultsCount">{{ antiques|length }}</span> antiques found
    </div>
  </div>

  <!-- Antiques Grid -->
  <div class="antiques-grid" id="antiquesGrid">
    {% for a in antiques %}
    <div
      class="antique-card"
      data-title="{{ a.title|lower }}"
      data-description="{{ a.description|lower }}"
      data-type="{{ a.type_of_antique }}"
      onclick="window.location.href='{% url 'antiques:antique_detail' a.short_id a.slug %}'"
    >
      <div class="card-img-wrapper">
        {% if a.images.exists %}
        <img src="{{ a.images.first.image.url }}" alt="{{ a.title }}" loading="lazy" />
        {% else %}
        <img src="{% static 'images/placeholder.png' %}" alt="No Image Available" />
        {% endif %}
      </div>
      <div class="card-body">
        <h5 class="card-title">{{ a.title }}</h5>
        <p class="card-type"><i class="fa-solid fa-tag"></i> {{ a.type_of_antique }}</p>
        <p class="card-description">{{ a.description|truncatewords:15 }}</p>
        <div class="card-footer">
          <p class="price-tag">${{ a.price }}</p>
          {% if a.quantity > 0 %}
          <span class="stock-badge in-stock">In Stock</span>
          {% else %}
          <span class="stock-badge out-of-stock">Sold Out</span>
          {% endif %}
        </div>
      </div>
    </div>
    {% empty %}
    <div class="no-results">
      <i class="fa-solid fa-search"></i>
      <p>No antiques found</p>
    </div>
    {% endfor %}
  </div>
</div>

<script src="{% static 'js/antiques/view_antiques.js' %}"></script>

<script>
  const toggle = document.getElementById("showSoldToggle");
  const typeFilter = document.getElementById("typeFilter");
  const searchInput = document.getElementById("searchInput");

  function updateFilters() {
    const params = new URLSearchParams(window.location.search);

    // Search
    if(searchInput.value.trim()) {
      params.set("search", searchInput.value.trim());
    } else {
      params.delete("search");
    }

    // Type Filter
    if(typeFilter.value) {
      params.set("type", typeFilter.value);
    } else {
      params.delete("type");
    }

    // Sold Toggle
    if(toggle.checked) {
      params.set("show_sold", "true");
    } else {
      params.delete("show_sold"); // default = for-sale
    }

    // Reload page with updated query string
    window.location.search = params.toString();
  }

  toggle.addEventListener("change", updateFilters);
  typeFilter.addEventListener("change", updateFilters);
  searchInput.addEventListener("keypress", (e) => {
    if(e.key === "Enter") updateFilters();
  });
</script>
{% endblock %}
