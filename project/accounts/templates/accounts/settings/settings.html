{% extends 'dashboard/base.html' %}

{% block content %}
<div class="settings-container">
  <h1>Account Settings</h1>

  <form method="post" class="settings-form">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="btn">Save changes</button>
  </form>

  <div class="account-actions">
    <a href="{% url 'accounts:logout_view' %}" 
       class="btn btn-danger"
       onclick="return confirm('Are you sure you want to log out?');">
      Logout
    </a>

    {% if request.user.is_email_verified %}
      <p class="verified-text">Your email is verified âœ…</p>
    {% else %}
      <p class="unverified-text">Your account is not verified. Please verify for full access</p>
      <button type="button" class="btn" id="openVerifyEmailModal">
        Verify Email
      </button>
    {% endif %}

    <a href="{% url 'payments:orders' %}" class="btn">View Orders</a>

    <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#verifyPasswordModal">
      Verify Password
    </button>
  </div>

  {% if user.is_superuser %}
    <div class="superuser-actions">
      <a class="btn" href="{% url 'accounts:seller_form' %}">Become a Seller</a>
      <a class="btn" href="{% url 'admin:index' %}">Admin Dashboard</a>
    </div>
  {% endif %}
</div>

<!-- Email Verification Modal -->
<div class="modal fade" id="verifyEmailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Verify Your Email</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Enter the 6-digit verification code sent to your email:</p>
        <form id="verifyEmailForm">
          {% csrf_token %}
          <input type="text" 
                 name="code" 
                 id="verificationCodeInput"
                 placeholder="123456" 
                 maxlength="6"
                 pattern="[0-9]{6}"
                 required>
          <button type="submit" class="btn-submit">Verify Code</button>
        </form>
        <div style="margin-top: 15px; text-align: center;">
          <button id="resendEmailBtn" class="btn-resend">Resend Code</button>
        </div>
        <div id="verifyEmailMessage" class="message-box"></div>
      </div>
    </div>
  </div>
</div>

<!-- Password Verification Modal -->
<div class="modal fade" id="verifyPasswordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Verify Password</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="verifyPasswordForm">
          {% csrf_token %}
          <input type="password" 
                 name="password" 
                 id="passwordInput"
                 placeholder="Enter your password" 
                 required>
          <button type="submit" class="btn-submit">Verify Password</button>
        </form>
        <div id="verifyPasswordMessage" class="message-box"></div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Container */
  .settings-container {
      max-width: 600px;
      margin: 2rem auto;
      padding: 2rem;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
  }

  /* Heading */
  .settings-container h1 {
      text-align: center;
      margin-bottom: 2rem;
      font-weight: 600;
      color: #333;
  }

  /* Forms */
  .settings-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
  }

  .settings-form input, 
  .settings-form select, 
  .settings-form textarea {
      padding: 0.6rem 0.75rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.2s ease;
  }

  .settings-form input:focus,
  .settings-form select:focus,
  .settings-form textarea:focus {
      outline: none;
      border-color: #4CAF50;
  }

  /* Buttons */
  .btn-save, .btn, .btn-primary, .btn-secondary, .btn-danger {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
  }

  .btn-save { 
      background: #4CAF50; 
      color: white;
      width: 100%;
  }
  .btn-primary { background: #0d6efd; color: white; }
  .btn-secondary { background: #6c757d; color: white; }
  .btn-danger { background: #dc3545; color: white; }

  .btn-save:hover, .btn:hover, .btn-primary:hover, .btn-secondary:hover, .btn-danger:hover {
      opacity: 0.85;
      transform: translateY(-1px);
  }

  /* Status Text */
  .verified-text { 
      color: #28a745; 
      margin: 1rem 0; 
      font-weight: 500;
      text-align: center;
  }

  .unverified-text { 
      color: #ff6b6b; 
      font-weight: 500; 
      margin: 1rem 0;
      text-align: center;
  }

  /* Layout sections */
  .account-actions {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e0e0e0;
  }

  .superuser-actions { 
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e0e0e0;
  }

  /* Modal Styles */
  .modal-content { 
      border-radius: 12px; 
      padding: 10px;
      border: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  .modal-header {
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 1rem;
  }

  .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #333;
  }

  .modal-body {
      padding: 1.5rem 0;
  }

  .modal-body p {
      margin-bottom: 1rem;
      color: #666;
  }

  .modal-body input { 
      width: 100%; 
      padding: 0.75rem; 
      border-radius: 6px; 
      border: 1px solid #ccc; 
      margin-bottom: 1rem;
      font-size: 1rem;
      transition: border-color 0.2s ease;
  }

  .modal-body input:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
  }

  .btn-submit { 
      background: #4CAF50; 
      color: white; 
      width: 100%; 
      padding: 0.75rem; 
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
  }

  .btn-submit:hover {
      background: #45a049;
      transform: translateY(-1px);
  }

  .btn-submit:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
  }

  .btn-resend { 
      background: #0d6efd; 
      color: white; 
      padding: 0.5rem 1.5rem; 
      border-radius: 6px; 
      border: none; 
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
  }

  .btn-resend:hover {
      background: #0b5ed7;
  }

  /* Message Box */
  .message-box {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 6px;
      font-size: 0.9rem;
      display: none;
  }

  .message-box.show {
      display: block;
  }

  .message-box.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
  }

  .message-box.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
  }

  /* Responsive */
  @media (max-width: 768px) {
      .settings-container {
          margin: 1rem;
          padding: 1.5rem;
      }
  }
</style>

<script>
// --- Helper functions ---
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

function showMessage(elementId, message, isSuccess) {
    const el = document.getElementById(elementId);
    el.textContent = message;
    el.className = 'message-box show ' + (isSuccess ? 'success' : 'error');
}

// --- Resend cooldown ---
function startResendCooldown(btn, duration = 30) {
    btn.disabled = true;
    let countdown = duration;
    btn.textContent = `Resend Code (${countdown}s)`;

    const interval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
            btn.textContent = `Resend Code (${countdown}s)`;
        } else {
            clearInterval(interval);
            btn.disabled = false;
            btn.textContent = 'Resend Code';
        }
    }, 1000);
}

// --- Send verification code ---
function sendVerificationCode(btn) {
    btn.disabled = true;
    btn.textContent = 'Sending...';

    fetch("{% url 'accounts:send_verification_code_ajax' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    })
    .then(res => res.json())
    .then(data => {
        showMessage('verifyEmailMessage', data.message, data.success);
        if (data.success) startResendCooldown(btn);
    })
    .catch(() => {
        showMessage('verifyEmailMessage', 'Error sending code. Please try again.', false);
        btn.disabled = false;
        btn.textContent = 'Resend Code';
    });
}

// --- Modal open: auto-send code ---
const openModalBtn = document.getElementById('openVerifyEmailModal');
const resendBtn = document.getElementById('resendEmailBtn');

if (openModalBtn) {
    openModalBtn.addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('verifyEmailModal'));
        modal.show();

        // Auto-send code when modal opens
        if (resendBtn) sendVerificationCode(resendBtn);
    });
}

// --- Resend button click ---
if (resendBtn) {
    resendBtn.addEventListener('click', () => sendVerificationCode(resendBtn));
}

// --- Verify email form submit ---
const verifyEmailForm = document.getElementById('verifyEmailForm');
if (verifyEmailForm) {
    verifyEmailForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const submitBtn = verifyEmailForm.querySelector('.btn-submit');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Verifying...';

        const formData = new FormData(verifyEmailForm);

        fetch("{% url 'accounts:verify_email_ajax' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            showMessage('verifyEmailMessage', data.message, data.verified || data.success);
            if (data.verified || data.success) setTimeout(() => location.reload(), 1000);
            else {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Verify Code';
            }
        })
        .catch(() => {
            showMessage('verifyEmailMessage', 'Error verifying code. Please try again.', false);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Verify Code';
        });
    });
}

// --- Clear messages when modal closes ---
document.getElementById('verifyEmailModal')?.addEventListener('hidden.bs.modal', () => {
    document.getElementById('verifyEmailMessage').className = 'message-box';
    document.getElementById('verificationCodeInput').value = '';
});
</script>

{% endblock %}